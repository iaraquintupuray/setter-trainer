<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SETTER TRAINER</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;1,400&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #080b0f;
  --surface: #0e1318;
  --surface2: #141b22;
  --border: #1e2a35;
  --border2: #253040;
  --accent: #e8a020;
  --accent-glow: rgba(232,160,32,0.12);
  --accent-dim: rgba(232,160,32,0.25);
  --red: #d94040;
  --red-dim: rgba(217,64,64,0.15);
  --green: #3a9e5f;
  --green-dim: rgba(58,158,95,0.15);
  --text: #d8dde3;
  --text-dim: #5a6878;
  --text-mid: #8a99aa;
  --mono: 'IBM Plex Mono', monospace;
  --serif: 'Lora', serif;
  --display: 'Bebas Neue', sans-serif;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--serif);
  min-height: 100vh;
  overflow-x: hidden;
}

/* scrollbar */
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* ─── SCREENS ─── */
.screen { display: none; min-height: 100vh; }
.screen.active { display: flex; }

/* ═══════════════════════════════
   SCREEN — HOME
═══════════════════════════════ */
#screen-home {
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 24px;
  position: relative;
  overflow: hidden;
}

#screen-home::before {
  content: '';
  position: absolute;
  top: 0; left: 50%;
  transform: translateX(-50%);
  width: 800px; height: 400px;
  background: radial-gradient(ellipse at top, rgba(232,160,32,0.06) 0%, transparent 65%);
  pointer-events: none;
}

.home-eyebrow {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 5px;
  color: var(--accent);
  text-transform: uppercase;
  margin-bottom: 20px;
}

.home-logo {
  font-family: var(--display);
  font-size: clamp(72px, 12vw, 140px);
  letter-spacing: 4px;
  line-height: 0.88;
  text-align: center;
  color: var(--text);
  margin-bottom: 6px;
}

.home-logo em {
  color: var(--accent);
  font-style: normal;
}

.home-tagline {
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 3px;
  color: var(--text-dim);
  text-align: center;
  margin-bottom: 56px;
  text-transform: uppercase;
}

.home-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 40px 44px;
  width: 100%;
  max-width: 520px;
  position: relative;
}

.home-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
}

.field-group {
  margin-bottom: 24px;
}

.field-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 3px;
  color: var(--text-dim);
  text-transform: uppercase;
  display: block;
  margin-bottom: 10px;
}

.field-input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--mono);
  font-size: 14px;
  padding: 12px 16px;
  border-radius: 2px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.field-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.sim-options {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.sim-option {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 14px 16px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.sim-option:hover { border-color: var(--border2); }
.sim-option.selected { border-color: var(--accent); background: var(--accent-glow); }
.sim-option.selected::after {
  content: '✓';
  position: absolute;
  top: 8px; right: 10px;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--accent);
}

.sim-option-num {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--text-dim);
  margin-bottom: 4px;
  text-transform: uppercase;
}

.sim-option-name {
  font-size: 13px;
  font-family: var(--mono);
  color: var(--text);
  font-weight: 600;
}

.sim-option-role {
  font-size: 11px;
  color: var(--text-dim);
  font-family: var(--mono);
  margin-top: 2px;
}

.btn-start {
  width: 100%;
  background: var(--accent);
  color: #000;
  border: none;
  font-family: var(--display);
  font-size: 24px;
  letter-spacing: 3px;
  padding: 18px;
  cursor: pointer;
  border-radius: 2px;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-start:hover { background: #d49018; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(232,160,32,0.2); }
.btn-start:disabled { background: var(--border2); color: var(--text-dim); cursor: not-allowed; transform: none; box-shadow: none; }

.error-msg {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--red);
  margin-top: 8px;
  display: none;
}
.error-msg.show { display: block; }

/* ═══════════════════════════════
   SCREEN — SIM
═══════════════════════════════ */
#screen-sim {
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

.sim-topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  height: 54px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  gap: 16px;
}

.sim-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.mode-pill {
  font-family: var(--mono);
  font-size: 8px;
  letter-spacing: 3px;
  padding: 4px 10px;
  border-radius: 1px;
  text-transform: uppercase;
  background: var(--accent);
  color: #000;
  font-weight: 600;
}

.lead-info .lead-name {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}

.lead-info .lead-role {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-dim);
}

.sim-center {
  flex: 1;
  display: flex;
  justify-content: center;
}

.stage-track {
  display: flex;
  align-items: center;
  gap: 4px;
}

.stage-dot {
  width: 28px; height: 28px;
  border-radius: 50%;
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-dim);
  transition: all 0.3s;
}

.stage-dot.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
.stage-dot.done { border-color: var(--green); color: var(--green); background: var(--green-dim); }

.stage-line {
  width: 20px; height: 1px;
  background: var(--border);
  transition: background 0.3s;
}

.stage-line.done { background: var(--green); }

.sim-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.timer {
  font-family: var(--mono);
  font-size: 18px;
  letter-spacing: 3px;
  color: var(--text-mid);
  transition: color 0.3s;
}

.timer.warning { color: var(--red); animation: timerBlink 1s ease-in-out infinite; }

@keyframes timerBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.btn-exit {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--text-dim);
  background: transparent;
  border: 1px solid var(--border);
  padding: 6px 14px;
  cursor: pointer;
  border-radius: 2px;
  text-transform: uppercase;
  transition: all 0.2s;
}

.btn-exit:hover { border-color: var(--red); color: var(--red); }

/* Chat */
.chat-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 28px 24px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.msg {
  display: flex;
  gap: 10px;
  max-width: 72%;
  animation: fadeUp 0.25s ease;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.user { align-self: flex-end; flex-direction: row-reverse; }
.msg.system { align-self: center; max-width: 80%; }

.msg-av {
  width: 30px; height: 30px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 600;
  flex-shrink: 0;
  margin-top: 2px;
}

.msg.lead .msg-av { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(232,160,32,0.3); }
.msg.user .msg-av { background: var(--surface2); color: var(--text-mid); border: 1px solid var(--border); }

.msg-body { display: flex; flex-direction: column; gap: 4px; }

.msg-bubble {
  padding: 11px 16px;
  border-radius: 2px;
  font-size: 14px;
  line-height: 1.65;
  font-family: var(--serif);
}

.msg.lead .msg-bubble {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 2px solid var(--accent);
}

.msg.user .msg-bubble {
  background: var(--surface2);
  border: 1px solid var(--border);
}

.msg.system .msg-bubble {
  background: transparent;
  border: 1px dashed var(--border);
  color: var(--text-dim);
  font-family: var(--mono);
  font-size: 11px;
  text-align: center;
  padding: 8px 20px;
  letter-spacing: 1px;
}

.msg-time {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-dim);
  letter-spacing: 1px;
}

.msg.user .msg-time { text-align: right; }

/* Typing */
.typing-wrap {
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 4px 0;
  animation: fadeUp 0.2s ease;
}

.typing-av {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: var(--accent-dim);
  color: var(--accent);
  border: 1px solid rgba(232,160,32,0.3);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 600;
  flex-shrink: 0;
}

.typing-dots {
  display: flex; gap: 5px; align-items: center;
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 2px solid var(--accent);
  padding: 14px 18px;
  border-radius: 2px;
}

.td {
  width: 7px; height: 7px;
  background: var(--accent);
  border-radius: 50%;
  animation: bounce 1.2s infinite;
  opacity: 0.5;
}
.td:nth-child(2) { animation-delay: 0.2s; }
.td:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-5px); opacity: 1; }
}

/* Input */
.chat-input-bar {
  border-top: 1px solid var(--border);
  padding: 14px 24px;
  background: var(--surface);
  display: flex;
  gap: 10px;
  align-items: flex-end;
  flex-shrink: 0;
}

.input-wrap { flex: 1; display: flex; flex-direction: column; gap: 5px; }

.chat-textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--serif);
  font-size: 14px;
  padding: 11px 14px;
  border-radius: 2px;
  outline: none;
  resize: none;
  min-height: 46px;
  max-height: 120px;
  transition: border-color 0.2s;
  line-height: 1.5;
}

.chat-textarea:focus { border-color: var(--accent); }

.input-hint {
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text-dim);
  letter-spacing: 1px;
}

.btn-send {
  background: var(--accent);
  border: none;
  color: #000;
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 2px;
  padding: 12px 18px;
  cursor: pointer;
  border-radius: 2px;
  transition: all 0.2s;
  text-transform: uppercase;
  white-space: nowrap;
  height: 46px;
}

.btn-send:hover { background: #d49018; }
.btn-send:disabled { background: var(--border2); color: var(--text-dim); cursor: not-allowed; }

/* ═══════════════════════════════
   SCREEN — EVAL
═══════════════════════════════ */
#screen-eval {
  flex-direction: column;
  min-height: 100vh;
}

.eval-topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 18px 40px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.eval-topbar h1 {
  font-family: var(--display);
  font-size: 32px;
  letter-spacing: 3px;
}

.eval-topbar h1 em { color: var(--accent); font-style: normal; }

.eval-meta {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-dim);
  text-align: right;
  line-height: 1.7;
}

.eval-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 40px;
}

.eval-inner {
  max-width: 860px;
  margin: 0 auto;
}

/* Loading */
.eval-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  padding: 80px 0;
}

.eval-loading p {
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 3px;
  color: var(--text-dim);
  text-transform: uppercase;
}

.loading-bar {
  width: 240px; height: 2px;
  background: var(--border);
  border-radius: 1px;
  overflow: hidden;
}

.loading-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-dim), var(--accent));
  border-radius: 1px;
  animation: loadAnim 2.5s ease-in-out infinite;
}

@keyframes loadAnim {
  0% { width: 0; margin-left: 0; }
  50% { width: 80%; }
  100% { width: 0; margin-left: 100%; }
}

/* Score hero */
.score-hero {
  display: flex;
  gap: 32px;
  align-items: center;
  padding: 32px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  margin-bottom: 36px;
  position: relative;
  overflow: hidden;
}

.score-hero::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
}

.score-hero.pass::before { background: linear-gradient(90deg, transparent, var(--green), transparent); }
.score-hero.partial::before { background: linear-gradient(90deg, transparent, var(--accent), transparent); }
.score-hero.fail::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }
.score-hero.auto-fail::before { background: linear-gradient(90deg, transparent, var(--red), transparent); }

.score-ring {
  width: 110px; height: 110px;
  border-radius: 50%;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  flex-shrink: 0;
  border: 3px solid;
  position: relative;
}

.score-ring.pass { border-color: var(--green); }
.score-ring.partial { border-color: var(--accent); }
.score-ring.fail, .score-ring.auto-fail { border-color: var(--red); }

.score-num {
  font-family: var(--display);
  font-size: 44px;
  line-height: 1;
}

.score-ring.pass .score-num { color: var(--green); }
.score-ring.partial .score-num { color: var(--accent); }
.score-ring.fail .score-num, .score-ring.auto-fail .score-num { color: var(--red); }

.score-pts {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--text-dim);
  text-transform: uppercase;
}

.score-info { flex: 1; }

.verdict-badge {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 3px;
  text-transform: uppercase;
  padding: 4px 12px;
  border-radius: 1px;
  display: inline-block;
  margin-bottom: 12px;
}

.verdict-badge.pass { background: var(--green-dim); color: var(--green); border: 1px solid var(--green); }
.verdict-badge.partial { background: var(--accent-glow); color: var(--accent); border: 1px solid var(--accent); }
.verdict-badge.fail, .verdict-badge.auto-fail { background: var(--red-dim); color: var(--red); border: 1px solid var(--red); }

.verdict-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 8px;
  font-family: var(--mono);
  color: var(--text);
}

.verdict-sub {
  font-size: 14px;
  color: var(--text-mid);
  line-height: 1.6;
  font-family: var(--serif);
}

/* Stage breakdown */
.stage-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 36px;
}

.stage-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 18px;
}

.stage-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.stage-card-name {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--text-dim);
  text-transform: uppercase;
  line-height: 1.4;
}

.stage-card-score {
  font-family: var(--mono);
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
}

.stage-card-score.good { color: var(--green); }
.stage-card-score.ok { color: var(--accent); }
.stage-card-score.bad { color: var(--red); }

.stage-bar {
  height: 3px;
  background: var(--border);
  border-radius: 1px;
  overflow: hidden;
  margin-bottom: 8px;
}

.stage-bar-fill {
  height: 100%;
  border-radius: 1px;
  transition: width 1s ease;
}

.stage-bar-fill.good { background: var(--green); }
.stage-bar-fill.ok { background: var(--accent); }
.stage-bar-fill.bad { background: var(--red); }

.stage-card-note {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--serif);
  font-style: italic;
  line-height: 1.4;
}

/* Sections */
.eval-section { margin-bottom: 36px; }

.section-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 4px;
  color: var(--accent);
  text-transform: uppercase;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 18px;
}

.error-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid;
  padding: 16px 18px;
  margin-bottom: 10px;
  border-radius: 0 2px 2px 0;
}

.error-card.critical { border-left-color: var(--red); }
.error-card.warning { border-left-color: var(--accent); }

.error-card-title {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
}

.error-card-desc {
  font-size: 13px;
  color: var(--text-mid);
  line-height: 1.55;
  font-family: var(--serif);
}

.phrase-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--green);
  padding: 16px 18px;
  margin-bottom: 10px;
  border-radius: 0 2px 2px 0;
}

.phrase-context {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-bottom: 8px;
}

.phrase-text {
  font-size: 14px;
  color: var(--green);
  font-style: italic;
  line-height: 1.6;
  margin-bottom: 6px;
  font-family: var(--serif);
}

.phrase-why {
  font-size: 12px;
  color: var(--text-dim);
  font-family: var(--serif);
}

.next-block {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 24px;
  margin-bottom: 36px;
  font-size: 14px;
  color: var(--text-mid);
  line-height: 1.7;
  font-family: var(--serif);
}

.btn-restart {
  background: var(--accent);
  color: #000;
  border: none;
  font-family: var(--display);
  font-size: 22px;
  letter-spacing: 3px;
  padding: 16px 48px;
  cursor: pointer;
  border-radius: 2px;
  transition: all 0.2s;
  display: block;
  margin: 0 auto 60px;
}

.btn-restart:hover { background: #d49018; transform: translateY(-1px); }

/* Responsive */
@media (max-width: 600px) {
  .sim-center { display: none; }
  .eval-scroll { padding: 20px; }
  .eval-topbar { padding: 14px 20px; }
  .score-hero { flex-direction: column; text-align: center; }
  .stage-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<!-- ══════════ SCREEN HOME ══════════ -->
<div id="screen-home" class="screen active">
  <div class="home-eyebrow">// Entrenamiento de setters</div>
  <h1 class="home-logo">SETTER<br><em>TRAINER</em></h1>
  <p class="home-tagline">Simulador de conversaciones de ventas</p>

  <div class="home-card">
    <div class="field-group">
      <label class="field-label" for="student-name">Tu nombre</label>
      <input class="field-input" id="student-name" type="text" placeholder="Ej: Lucía García" autocomplete="off" />
    </div>

    <div class="field-group">
      <label class="field-label">Elegí el simulacro</label>
      <div class="sim-options" id="sim-options">
        <div class="sim-option" data-sim="1" onclick="selectSim(1)">
          <div class="sim-option-num">Simulacro 01</div>
          <div class="sim-option-name">Laura</div>
          <div class="sim-option-role">Coach fitness · Frío · Agenda</div>
        </div>
        <div class="sim-option" data-sim="2" onclick="selectSim(2)">
          <div class="sim-option-num">Simulacro 02</div>
          <div class="sim-option-name">Valentina</div>
          <div class="sim-option-role">Asesora imagen · Frío · Agenda</div>
        </div>
        <div class="sim-option" data-sim="3" onclick="selectSim(3)">
          <div class="sim-option-num">Simulacro 03</div>
          <div class="sim-option-name">Luis</div>
          <div class="sim-option-role">Abogado · Caliente · Venta</div>
        </div>
        <div class="sim-option" data-sim="4" onclick="selectSim(4)">
          <div class="sim-option-num">Simulacro 04</div>
          <div class="sim-option-name">Matias</div>
          <div class="sim-option-role">Barista · Tibio · Agenda</div>
        </div>
      </div>
    </div>

    <div id="home-error" class="error-msg">Completá tu nombre y seleccioná un simulacro para continuar.</div>
    <button class="btn-start" id="btn-start" onclick="startSim()">COMENZAR SIMULACRO</button>
  </div>
</div>

<!-- ══════════ SCREEN SIM ══════════ -->
<div id="screen-sim" class="screen">
  <div class="sim-topbar">
    <div class="sim-left">
      <div class="mode-pill" id="mode-pill">SIMULACRO</div>
      <div class="lead-info">
        <div class="lead-name" id="lead-name-display">—</div>
        <div class="lead-role" id="lead-role-display">—</div>
      </div>
    </div>

    <div class="sim-center">
      <div class="stage-track">
        <div class="stage-dot active" id="stage-1" title="Bienvenida">1</div>
        <div class="stage-line" id="line-1"></div>
        <div class="stage-dot" id="stage-2" title="Descubrimiento">2</div>
        <div class="stage-line" id="line-2"></div>
        <div class="stage-dot" id="stage-3" title="Educación + Pitch">3</div>
        <div class="stage-line" id="line-3"></div>
        <div class="stage-dot" id="stage-4" title="Cierre">4</div>
      </div>
    </div>

    <div class="sim-right">
      <div class="timer" id="timer">60:00</div>
      <button class="btn-exit" onclick="confirmExit()">SALIR</button>
    </div>
  </div>

  <div class="chat-scroll" id="chat-scroll"></div>

  <div class="chat-input-bar">
    <div class="input-wrap">
      <textarea class="chat-textarea" id="chat-input" placeholder="Escribí tu mensaje..." rows="1"
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <div class="input-hint">Escribí SALIR para abandonar el simulacro (cuenta como desaprobado)</div>
    </div>
    <button class="btn-send" id="btn-send" onclick="sendMessage()">ENVIAR</button>
  </div>
</div>

<!-- ══════════ SCREEN EVAL ══════════ -->
<div id="screen-eval" class="screen">
  <div class="eval-topbar">
    <h1>FEEDBACK <em>FINAL</em></h1>
    <div class="eval-meta" id="eval-meta">—</div>
  </div>
  <div class="eval-scroll">
    <div class="eval-inner" id="eval-inner">
      <div class="eval-loading" id="eval-loading">
        <p>Analizando la conversación...</p>
        <div class="loading-bar"><div class="loading-fill"></div></div>
      </div>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════
//  DATA — SIMULACROS
// ══════════════════════════════════════════════
const SIMULACROS = {
  1: {
    leadName: "Laura",
    leadAge: 33,
    leadRole: "Coach fitness",
    tipo: "Prospección fría — el alumno inicia",
    objetivo: "Agenda (fecha y hora concretas)",
    situacion: "Maneja todo el negocio sola. Sobrecarga de trabajo. Debe atender gran volumen de clientes, sin tiempo personal.",
    dolorPrincipal: "Sobrecarga de trabajo",
    dolorSecundario: "Sin tiempo personal",
    deseoPrincipal: "Escalar su negocio sin sacrificar tiempo personal",
    deseoSecundario: "Libertad de tiempo, pasar más tiempo con su familia",
    creenciaLimitante: "Si cobro más caro, se me van los clientes",
    consciencia: "Está buscando solución activamente",
    tono: "Abierta pero escéptica. Dice cosas como 'laburo todo el día, nadie lo haría como yo'",
    objeciones: [
      { obj: "Enviame esto por email / mandame la info", bien: "Laura suspira y dice 'bueno, contame de qué se trata pero rápido'", mal: "Dice 'ok gracias' y deja de responder o responde con monosílabos" },
      { obj: "No es un buen momento ahora", bien: "Da una fecha concreta y se muestra levemente más abierta", mal: "Dice 'sí dale' y la conversación muere" },
      { obj: "No tengo tiempo / Quiero hacerlo más adelante", bien: "Se detiene, dice algo como 'sí, es verdad, estoy harta de esto'", mal: "Se cierra y responde seco" }
    ],
    oferta: {
      coach: "Teo Egaña",
      producto: "Wave Agencia",
      dirigido: "Profesionales, emprendedores, coaches, infoproductores",
      problema: "Escalar su negocio en 90 días",
      mecanismo: "Embudo de ventas, oferta high ticket, sistema de adquisición de clientes, setter, asesoramiento 1a1, sesiones grupales L-V con expertos en marketing y ventas, fullfilment, contenido orgánico, ads y prospección, formación para liderar equipo de ventas, acceso a contenido en Skool",
      resultado: "Escalar en 90 días",
      diferencial: "Devolvemos el 100% de la inversión si no cumplimos el objetivo",
      noEs: "Un curso genérico"
    },
    exito: "Lead acepta una llamada con día y horario concreto"
  },
  2: {
    leadName: "Valentina",
    leadAge: 30,
    leadRole: "Asesora de imagen",
    tipo: "Prospección fría — el alumno inicia",
    objetivo: "Agenda (fecha y hora concretas)",
    situacion: "Clientes esporádicos, un mes sí y un mes no. Ama la profesión pero no vende lo suficiente para vivir 100% de esto.",
    dolorPrincipal: "No vende lo suficiente para vivir de su profesión",
    dolorSecundario: "Frustración, desgaste",
    deseoPrincipal: "Estabilidad económica, vivir 100% de su trabajo",
    deseoSecundario: "Poder viajar gracias al trabajo que ama",
    creenciaLimitante: "Es cosa de suerte y yo no la tengo",
    consciencia: "Sabe que tiene el problema pero no conoce la solución",
    tono: "Desconfiada, curiosa",
    objeciones: [
      { obj: "No tengo tiempo / Quiero hacerlo más adelante", bien: "Baja la guardia y empieza a abrirse sobre su situación real", mal: "Se pone más fría y desconfiada" },
      { obj: "¿Qué sucede si esto no funciona?", bien: "Dice algo como 'la verdad que eso tiene sentido, nunca lo había pensado así'", mal: "Dice 'sí, seguro' con tono irónico y se cierra" },
      { obj: "Lo tengo que pensar", bien: "Revela su objeción real (dinero o miedo a fallar)", mal: "Dice 'bueno, te aviso' y no vuelve" }
    ],
    oferta: {
      coach: "Lina Diaz",
      producto: "Sistema magnético para clientes High Ticket",
      dirigido: "Asesoras de imagen",
      problema: "Escalar la carrera de asesora de imagen a +$100.000 USD/año creando un embudo de ventas que atraiga clientes calificados",
      mecanismo: "Sistema magnético para clientes high ticket",
      resultado: "+$100.000 USD/año, clientes calificados de manera consistente",
      diferencial: "Lina es asesora de imagen, sabe qué funciona en este nicho específico",
      noEs: "Curso genérico de asesoría"
    },
    exito: "Lead acepta una llamada con fecha y hora concreta"
  },
  3: {
    leadName: "Luis",
    leadAge: 45,
    leadRole: "Abogado",
    tipo: "Lead caliente — responde a un CTA",
    objetivo: "Venta directa ($150 USD)",
    situacion: "Vive apagando incendios. Los imprevistos atentan contra su planificación. Estresado, desbordado.",
    dolorPrincipal: "Los imprevistos destruyen su planificación",
    dolorSecundario: "Estrés, se siente desbordado por el trabajo",
    deseoPrincipal: "Sentirse en control de su tiempo",
    deseoSecundario: "Más tranquilidad, menos estrés",
    creenciaLimitante: "No se puede, es imposible para mí",
    consciencia: "Sabe que tiene el problema y está explorando opciones",
    tono: "Abierto pero escéptico",
    objeciones: [
      { obj: "Lo tengo que pensar", bien: "Admite que en realidad tiene miedo de arrancar algo nuevo y no sostenerlo", mal: "Dice 'sí, te escribo' y desaparece" },
      { obj: "Es muy caro", bien: "Dice 'mirá, nunca lo había pensado desde ese lado'", mal: "Dice 'sí pero igual es mucho' y se cierra" },
      { obj: "Déjame hablar con mi esposa", bien: "Dice 'sí, a mí me parece que tiene sentido, el tema es convencerla a ella'", mal: "Dice 'sí dale' y no vuelve" }
    ],
    oferta: {
      coach: "Nico Fernandez Miranda",
      producto: "Instituto de Productividad",
      dirigido: "Personas con agendas exigentes (estudiantes, profesionales, emprendedores)",
      problema: "Ayuda a organizarse mejor, sostener hábitos clave y avanzar en objetivos sin depender solo de la fuerza de voluntad",
      mecanismo: "4 pilares: 1) Planificación con propósito, 2) Herramientas prácticas, 3) Espacios de implementación, 4) Acceso inmediato a planificaciones, workshops, co-workings y grupo activo",
      resultado: "Organizarse mejor, sostener hábitos y avanzar en objetivos",
      diferencial: "Acompañamiento de profesionales, coaches y equipo en tiempo real, resolviendo dudas y dando seguimiento",
      noEs: "Consultoría, mentoría, programa",
      precio: "$150 USD"
    },
    exito: "Lead compra (da datos de pago o confirma compra)"
  },
  4: {
    leadName: "Matias",
    leadAge: 35,
    leadRole: "Barista",
    tipo: "Prospección tibia — setter da la bienvenida",
    objetivo: "Agenda (fecha y hora concretas)",
    situacion: "Tiene sobrepeso. Intentó mil formas de bajar de peso pero nada funcionó. Dolor, inseguridad consigo mismo.",
    dolorPrincipal: "Intentó mil formas de bajar de peso y nada funcionó",
    dolorSecundario: "Dolor físico, inseguridad, baja autoestima",
    deseoPrincipal: "Bajar de peso",
    deseoSecundario: "Sentirse bien y con seguridad en sí mismo",
    creenciaLimitante: "Siempre abandono, siempre fue así",
    consciencia: "Sabe que tiene el problema, mostró interés pasivo (siguió la cuenta / consumió contenido)",
    tono: "Desconfiado",
    objeciones: [
      { obj: "No tengo tiempo / Quiero hacerlo más adelante", bien: "Baja la guardia y dice 'sí, tenés razón, ya lo postergué mil veces'", mal: "Dice 'bueno, te aviso' y se enfría" },
      { obj: "¿Qué sucede si esto no funciona?", bien: "Dice 'eso de que no te dejan solo suena distinto a lo que probé antes'", mal: "Dice 'eso dicen todos' y se cierra" },
      { obj: "Lo tengo que pensar", bien: "Confiesa que el miedo real es volver a fallar y sentirse peor", mal: "Dice 'sí, te escribo' y no vuelve" }
    ],
    oferta: {
      coach: "Alexa Fitness",
      producto: "Programa fitness",
      dirigido: "Personas con sobrepeso que vienen intentando múltiples métodos",
      problema: "Ayuda a personas con sobrepeso a dejar de tener hambre constante y ansiedad por la comida",
      mecanismo: "Programa con seguimiento en tiempo real, que enseña a tomar las mejores decisiones para la salud",
      resultado: "Dejar de tener hambre constante, ansiedad por la comida, y lograr resultados óptimos",
      diferencial: "Nunca dejan de dar información, el alumno entiende POR QUÉ puede o no mantenerse con cierta alimentación",
      noEs: "Un curso genérico"
    },
    exito: "Lead acepta una llamada con fecha y hora concreta"
  }
};

// ══════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════
let state = {
  studentName: '',
  simNum: null,
  simData: null,
  messages: [],       // {role, content}
  stage: 1,           // 1-4
  timerInterval: null,
  secondsLeft: 3600,
  simEnded: false,
  endReason: null,    // 'success' | 'abandoned' | 'timeout'
  startTime: null
};

// ══════════════════════════════════════════════
//  HOME
// ══════════════════════════════════════════════
function selectSim(n) {
  document.querySelectorAll('.sim-option').forEach(el => el.classList.remove('selected'));
  document.querySelector(`.sim-option[data-sim="${n}"]`).classList.add('selected');
  state.simNum = n;
}

async function startSim() {
  const name = document.getElementById('student-name').value.trim();
  if (!name || !state.simNum) {
    document.getElementById('home-error').classList.add('show');
    return;
  }
  document.getElementById('home-error').classList.remove('show');
  state.studentName = name;
  state.simData = SIMULACROS[state.simNum];
  state.messages = [];
  state.stage = 1;
  state.secondsLeft = 3600;
  state.simEnded = false;
  state.endReason = null;
  state.startTime = new Date();

  showScreen('sim');
  setupSimUI();
  startTimer();

  // System message - no visible
  const sysPrompt = buildLeadSystemPrompt();
  state.messages.push({ role: "user", content: `[SETUP INTERNO - NO VISIBLE AL ALUMNO]\n${sysPrompt}\n\nEl alumno se llama ${state.studentName}. El simulacro acaba de iniciar. Espera su primer mensaje sin decir nada todavía. Cuando responda a mensajes del alumno, responde SOLO como ${state.simData.leadName}, nunca rompes personaje.` });
  state.messages.push({ role: "assistant", content: `[Listo. Esperando el primer mensaje del alumno ${state.studentName} para comenzar el simulacro. Encarnaré completamente a ${state.simData.leadName}.]` });

  addSystemMsg(`Simulacro ${state.simNum} iniciado · Hablás con ${state.simData.leadName} · ${state.simData.leadRole}`);
  addSystemMsg(`Objetivo: ${state.simData.objetivo} · Escribí SALIR para abandonar`);
}

function setupSimUI() {
  const d = state.simData;
  document.getElementById('lead-name-display').textContent = d.leadName;
  document.getElementById('lead-role-display').textContent = `${d.leadRole} · Sim ${state.simNum}`;
  document.getElementById('chat-scroll').innerHTML = '';
  updateStageUI(1);
  document.getElementById('mode-pill').textContent = 'SIMULACRO';
  document.getElementById('mode-pill').style.background = 'var(--accent)';
}

// ══════════════════════════════════════════════
//  TIMER
// ══════════════════════════════════════════════
function startTimer() {
  clearInterval(state.timerInterval);
  state.timerInterval = setInterval(() => {
    state.secondsLeft--;
    updateTimerDisplay();
    if (state.secondsLeft <= 0 && !state.simEnded) {
      endSim('timeout');
    }
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(state.secondsLeft / 60).toString().padStart(2,'0');
  const s = (state.secondsLeft % 60).toString().padStart(2,'0');
  const el = document.getElementById('timer');
  el.textContent = `${m}:${s}`;
  el.classList.toggle('warning', state.secondsLeft < 300);
}

// ══════════════════════════════════════════════
//  CHAT
// ══════════════════════════════════════════════
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

async function sendMessage() {
  if (state.simEnded) return;
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  // Check SALIR
  if (text.toUpperCase() === 'SALIR') {
    addUserMsg(text);
    input.value = '';
    endSim('abandoned');
    return;
  }

  input.value = '';
  input.style.height = 'auto';
  addUserMsg(text);
  setBusy(true);

  // Add to messages
  state.messages.push({ role: "user", content: text });

  // Check stage advancement hint (invisible)
  const stageHint = getStageHint(text);

  try {
    const response = await callClaude(state.messages, stageHint);
    const reply = response.trim();
    state.messages.push({ role: "assistant", content: reply });

    // Detect stage advancement from response
    detectStageAdvance(text, reply);

    // Check end conditions
    const endCheck = checkSimEnd(text, reply);
    if (endCheck) {
      addLeadMsg(reply);
      setTimeout(() => endSim(endCheck), 800);
    } else {
      addLeadMsg(reply);
    }
  } catch(err) {
    addSystemMsg(`Error de conexión. Reintentá tu mensaje.`);
    state.messages.pop();
  }

  setBusy(false);
}

function getStageHint(userText) {
  // Subtle context injected as part of assistant turn to guide stage tracking
  return '';
}

function detectStageAdvance(userMsg, leadReply) {
  const combined = (userMsg + ' ' + leadReply).toLowerCase();
  // Basic heuristics — stage moves forward based on conversation content
  if (state.stage === 1) {
    // Move to stage 2 if lead shared basic info and conversation is flowing
    const hasBasicInfo = combined.includes('dedic') || combined.includes('negocio') || combined.includes('trabajo') || combined.includes('cobro') || combined.includes('vivo') || combined.includes('clientes');
    if (hasBasicInfo && state.messages.filter(m=>m.role==='user').length >= 2) {
      setStage(2);
    }
  } else if (state.stage === 2) {
    // Move to stage 3 if setter is presenting solution/pitch
    const pitchKeywords = ['vos me dijiste', 'justamente por eso', 'lo que te quiero contar', 'nuestra metodología', 'pasas de', 'punto a', 'punto b', 'te ayudaría', 'creamos', 'trabajamos con'];
    if (pitchKeywords.some(k => userMsg.toLowerCase().includes(k))) {
      setStage(3);
    }
  } else if (state.stage === 3) {
    // Move to stage 4 if setter proposes meeting/sale
    const closeKeywords = ['llamada', 'videollamada', 'reunión', 'charlar más', 'agendamos', 'tengo disponible', 'mañana', 'jueves', 'lunes', 'martes', 'miércoles', 'viernes'];
    if (closeKeywords.some(k => userMsg.toLowerCase().includes(k))) {
      setStage(4);
    }
  }
}

function checkSimEnd(userMsg, leadReply) {
  const combined = (userMsg + ' ' + leadReply).toLowerCase();
  const sim = state.simData;

  if (sim.objetivo.toLowerCase().includes('venta')) {
    // Sim 3 — end on confirmed purchase
    const purchaseSignals = ['confirmo', 'quiero comprarlo', 'cómo pago', 'cómo lo compro', 'me anoto', 'dale, lo tomo', 'listo lo compro', 'cómo hago el pago'];
    if (purchaseSignals.some(k => combined.includes(k))) return 'success';
  } else {
    // Agenda — end on confirmed date+time
    const agendaSignals = ['quedamos el', 'quedamos para el', 'perfecto el', 'dale, el', 'confirmo el', 'me queda bien el', 'agendado', 'confirmado', 'listo para el'];
    const timeSignals = ['17hs', '18hs', '19hs', '20hs', '15hs', '16hs', '10hs', '11hs', '12hs', 'hs', ':00', ':30'];
    const hasAgenda = agendaSignals.some(k => combined.includes(k));
    const hasTime = timeSignals.some(k => combined.includes(k));
    if (hasAgenda || (hasTime && state.stage >= 3)) return 'success';
  }
  return null;
}

// ══════════════════════════════════════════════
//  END SIM
// ══════════════════════════════════════════════
function confirmExit() {
  if (confirm('¿Confirmás que querés salir? El simulacro se registrará como desaprobado.')) {
    endSim('abandoned');
  }
}

function endSim(reason) {
  if (state.simEnded) return;
  state.simEnded = true;
  state.endReason = reason;
  clearInterval(state.timerInterval);

  if (reason === 'abandoned') {
    addSystemMsg('SIMULACRO TERMINADO — Abandono registrado');
  } else if (reason === 'timeout') {
    addSystemMsg('SIMULACRO TERMINADO — Tiempo agotado (60 minutos)');
  } else {
    addSystemMsg('SIMULACRO TERMINADO — Procesando evaluación...');
  }

  document.getElementById('btn-send').disabled = true;
  document.getElementById('chat-input').disabled = true;

  setTimeout(() => {
    showScreen('eval');
    runEvaluation();
  }, 1200);
}

// ══════════════════════════════════════════════
//  EVALUATION
// ══════════════════════════════════════════════
async function runEvaluation() {
  const meta = document.getElementById('eval-meta');
  const elapsed = Math.floor((new Date() - state.startTime) / 1000);
  const mm = Math.floor(elapsed/60).toString().padStart(2,'0');
  const ss = (elapsed%60).toString().padStart(2,'0');
  meta.innerHTML = `Alumno: ${state.studentName}<br>Simulacro ${state.simNum} — ${state.simData.leadName}<br>Duración: ${mm}:${ss}`;

  if (state.endReason === 'abandoned') {
    renderEvalResult(buildAutoFailResult('abandoned'));
    return;
  }

  const evalPrompt = buildEvalPrompt();
  try {
    const evalMessages = [{ role: "user", content: evalPrompt }];
    const raw = await callClaude(evalMessages, null);
    const parsed = parseEvalJSON(raw);
    renderEvalResult(parsed);
  } catch(e) {
    document.getElementById('eval-inner').innerHTML = `
      <div style="padding:40px;font-family:var(--mono);color:var(--red);font-size:12px;">
        Error al generar evaluación. Recargá la página e intentá nuevamente.<br>${e.message}
      </div>`;
  }
}

function buildAutoFailResult(reason) {
  return {
    status: 'auto-fail',
    totalScore: 0,
    verdictTitle: reason === 'abandoned' ? 'Simulacro abandonado' : 'Tiempo agotado',
    verdictSummary: reason === 'abandoned'
      ? 'El simulacro fue marcado como desaprobado por abandono voluntario. Para aprobar, es necesario completar las 4 etapas y lograr el objetivo establecido.'
      : 'Se agotó el límite de 60 minutos sin completar el objetivo. Practicá la velocidad de la conversación y la gestión del tiempo.',
    stages: [
      { name: 'Bienvenida', score: 0, max: 20, note: 'No evaluado' },
      { name: 'Descubrimiento', score: 0, max: 30, note: 'No evaluado' },
      { name: 'Educación + Pitch', score: 0, max: 30, note: 'No evaluado' },
      { name: 'Cierre', score: 0, max: 20, note: 'No evaluado' }
    ],
    errors: [{ severity: 'critical', title: 'Simulacro no completado', desc: reason === 'abandoned' ? 'El alumno abandonó el simulacro antes de completarlo.' : 'El tiempo límite de 60 minutos se agotó.' }],
    phrases: [],
    nextSteps: reason === 'abandoned' ? 'Volvé a intentar el simulacro completando las 4 etapas. Recordá que el objetivo es guiar la conversación hacia el cierre, no rendirse ante las dificultades.' : 'Trabajá la agilidad de la conversación. Practicá las transiciones entre etapas para reducir el tiempo total.'
  };
}

function buildEvalPrompt() {
  const sim = state.simData;
  const conv = state.messages
    .filter(m => !m.content.startsWith('[SETUP INTERNO') && !m.content.startsWith('[Listo.'))
    .map(m => `${m.role === 'user' ? state.studentName : sim.leadName}: ${m.content}`)
    .join('\n\n');

  return `Sos un evaluador experto en ventas y setters. Tu tarea es analizar la conversación de simulacro de ventas que te voy a pasar y devolver una evaluación estructurada en JSON.

CONTEXTO DEL SIMULACRO:
- Alumno: ${state.studentName}
- Lead: ${sim.leadName}, ${sim.leadAge} años, ${sim.leadRole}
- Tipo: ${sim.tipo}
- Objetivo del setter: ${sim.objetivo}
- Resultado: ${state.endReason === 'success' ? 'EXITOSO — logró el objetivo' : state.endReason === 'timeout' ? 'TIEMPO AGOTADO' : 'SIN COMPLETAR'}

PERFIL DEL LEAD:
- Situación: ${sim.situacion}
- Dolor principal: ${sim.dolorPrincipal}
- Dolor secundario: ${sim.dolorSecundario}
- Deseo principal: ${sim.deseoPrincipal}
- Deseo secundario: ${sim.deseoSecundario}
- Creencia limitante: ${sim.creenciaLimitante}
- Consciencia: ${sim.consciencia}
- Tono/personalidad: ${sim.tono}

OFERTA:
- Coach/Infoproductor: ${sim.oferta.coach}
- Producto: ${sim.oferta.producto}
- Dirigido a: ${sim.oferta.dirigido}
- Problema que resuelve: ${sim.oferta.problema}
- Mecanismo: ${sim.oferta.mecanismo}
- Resultado prometido: ${sim.oferta.resultado}
- Diferencial: ${sim.oferta.diferencial}
- No es: ${sim.oferta.noEs}
${sim.oferta.precio ? `- Precio: ${sim.oferta.precio}` : ''}

RÚBRICA DE EVALUACIÓN:

ETAPA 1 — BIENVENIDA (máx 20 puntos):
- 18-20: Mensaje personalizado + pregunta abierta natural. No hay pitch ni calificación prematura. Adapta tono al lead.
- 12-17: Bienvenida correcta pero genérica o pregunta cerrada.
- 6-11: Bienvenida fría o sin pregunta. Intenta calificar o menciona producto antes de tiempo.
- 0-5: No hay bienvenida real. Va directo al pitch o cierra la conversación desde el inicio.
- CUMPLIDA cuando: el lead dio información básica con al menos una respuesta desarrollada.

ETAPA 2 — DESCUBRIMIENTO (máx 30 puntos):
- 26-30: Obtuvo dolor real + carga emocional + deseos + qué impide lograrlo. Preguntas abiertas, técnica del eco. Lead mostró vulnerabilidad.
- 18-25: Obtuvo dolor pero superficial. Faltó emoción o deseos. Preguntas mayormente abiertas.
- 9-17: Preguntas cerradas, no escuchó activamente. Información básica sin carga emocional.
- 0-8: No hubo descubrimiento real. Pasó a etapa 3 sin info suficiente o presionó al lead.
- CUMPLIDA cuando: lead habló de dolores reales, cómo lo hacen sentir, deseos y qué le impide lograrlos.

ETAPA 3 — EDUCACIÓN + PITCH (máx 30 puntos):
- 26-30: Educación con estructura correcta (vos me dijiste → eso es común cuando → la mayoría no sabe que). Pitch personalizado con palabras exactas del lead, fórmula A→B clara, cerró con pregunta de confirmación.
- 18-25: Educación presente pero breve. Pitch con algunos elementos del lead.
- 9-17: Saltó educación, fue directo al pitch. Pitch genérico, vendió características no beneficios.
- 0-8: Sin educación. Pitch completamente genérico. Habló de módulos/herramientas sin conectar con el lead.
- CUMPLIDA cuando: identificó punto A y B, educó en 3-4 líneas, cerró el pitch con pregunta de confirmación.

ETAPA 4 — CIERRE (máx 20 puntos):
- 18-20: Transición natural, mini resumen de dolores/deseos, motivo claro, dos opciones concretas de día y hora. Lead acepta con fecha y hora específica.
- 12-17: Propuso la llamada pero sin resumen o con una sola opción.
- 6-11: Cierre tibio ("si querés podemos hablar, vos decime"). Sin opciones concretas.
- 0-5: No propuso agenda o lo hizo por ansiedad. Lead no confirmó fecha ni hora.
- CUMPLIDA cuando: hay fecha y hora concreta acordada, sin objeciones abiertas.

MANEJO DE OBJECIONES (bonus hasta +10 puntos si aplica):
- 8-10: Validó, preguntó para entender objeción real, reencuadró con certeza, volvió al cierre de forma humana.
- 4-7: Manejó objeción pero saltó algún paso.
- 0-3: Cedió, confrontó, ignoró o se rindió.

UMBRAL DE APROBACIÓN:
- 85-100: Aprobado con distinción
- 70-84: Aprobado
- 50-69: Desaprobado — puede reintentar
- 0-49: Desaprobado — reforzar fundamentos

CONVERSACIÓN COMPLETA:
${conv}

Analizá esta conversación con criterio estricto y profesional. Si una etapa no ocurrió, la puntuación es 0.

Devolvé ÚNICAMENTE un JSON válido (sin markdown, sin explicaciones fuera del JSON) con esta estructura exacta:
{
  "status": "pass-distinction" | "pass" | "fail-retry" | "fail-fundamentals",
  "totalScore": número del 0 al 100 (incluyendo bonus si aplica),
  "verdictTitle": "título breve del veredicto",
  "verdictSummary": "resumen de 2-3 oraciones del desempeño general",
  "stages": [
    { "name": "Bienvenida", "score": número, "max": 20, "note": "observación de 1 línea" },
    { "name": "Descubrimiento", "score": número, "max": 30, "note": "observación de 1 línea" },
    { "name": "Educación + Pitch", "score": número, "max": 30, "note": "observación de 1 línea" },
    { "name": "Cierre", "score": número, "max": 20, "note": "observación de 1 línea" }
  ],
  "bonusObjeciones": número o null,
  "errors": [
    { "severity": "critical" | "warning", "title": "título del error", "desc": "descripción detallada de qué pasó y por qué es un problema" }
  ],
  "phrases": [
    { "context": "en qué momento de la conversación", "text": "frase exacta o aproximada que debería haber dicho", "why": "por qué esta frase funciona mejor" }
  ],
  "nextSteps": "párrafo con recomendación concreta para el próximo intento"
}

Incluí entre 2 y 5 errores, y entre 1 y 4 frases sugeridas. Sé específico y constructivo.`;
}

function parseEvalJSON(raw) {
  try {
    const cleaned = raw.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
    return JSON.parse(cleaned);
  } catch(e) {
    // Fallback: extract JSON from text
    const match = raw.match(/\{[\s\S]*\}/);
    if (match) return JSON.parse(match[0]);
    throw new Error('No se pudo parsear la respuesta de evaluación');
  }
}

function renderEvalResult(data) {
  const statusMap = {
    'pass-distinction': { cls: 'pass', label: '✅ Aprobado con distinción' },
    'pass': { cls: 'pass', label: '✅ Aprobado' },
    'fail-retry': { cls: 'partial', label: '❌ Desaprobado — puede reintentar' },
    'fail-fundamentals': { cls: 'fail', label: '❌ Desaprobado — reforzar fundamentos' },
    'auto-fail': { cls: 'auto-fail', label: '❌ Desaprobado — simulacro no completado' }
  };

  const sv = statusMap[data.status] || statusMap['fail-retry'];
  const cls = sv.cls;

  const stagesHTML = (data.stages || []).map(s => {
    const pct = Math.round((s.score / s.max) * 100);
    const barCls = pct >= 70 ? 'good' : pct >= 40 ? 'ok' : 'bad';
    const scoreCls = pct >= 70 ? 'good' : pct >= 40 ? 'ok' : 'bad';
    return `
      <div class="stage-card">
        <div class="stage-card-header">
          <div class="stage-card-name">${s.name}</div>
          <div class="stage-card-score ${scoreCls}">${s.score}<span style="font-size:11px;color:var(--text-dim)">/${s.max}</span></div>
        </div>
        <div class="stage-bar"><div class="stage-bar-fill ${barCls}" style="width:${pct}%"></div></div>
        <div class="stage-card-note">${s.note}</div>
      </div>
    `;
  }).join('');

  const errorsHTML = (data.errors || []).map(e => `
    <div class="error-card ${e.severity}">
      <div class="error-card-title">${e.title}</div>
      <div class="error-card-desc">${e.desc}</div>
    </div>
  `).join('');

  const phrasesHTML = (data.phrases || []).map(p => `
    <div class="phrase-card">
      <div class="phrase-context">${p.context}</div>
      <div class="phrase-text">"${p.text}"</div>
      <div class="phrase-why">${p.why}</div>
    </div>
  `).join('');

  const bonusHTML = data.bonusObjeciones !== null && data.bonusObjeciones !== undefined
    ? `<div style="margin-bottom:8px;font-family:var(--mono);font-size:11px;color:var(--text-dim)">+ ${data.bonusObjeciones} puntos bonus por manejo de objeciones</div>`
    : '';

  document.getElementById('eval-inner').innerHTML = `
    <div class="score-hero ${cls}">
      <div class="score-ring ${cls}">
        <div class="score-num">${data.totalScore}</div>
        <div class="score-pts">/ 100 PTS</div>
      </div>
      <div class="score-info">
        <div class="verdict-badge ${cls}">${sv.label}</div>
        <div class="verdict-title">${data.verdictTitle || ''}</div>
        <div class="verdict-sub">${data.verdictSummary || ''}</div>
        ${bonusHTML}
      </div>
    </div>

    <div class="stage-grid">${stagesHTML}</div>

    ${errorsHTML ? `<div class="eval-section">
      <div class="section-label">// Errores detectados</div>
      ${errorsHTML}
    </div>` : ''}

    ${phrasesHTML ? `<div class="eval-section">
      <div class="section-label">// Qué debería haber dicho</div>
      ${phrasesHTML}
    </div>` : ''}

    ${data.nextSteps ? `<div class="eval-section">
      <div class="section-label">// Para el próximo intento</div>
      <div class="next-block">${data.nextSteps}</div>
    </div>` : ''}

    <button class="btn-restart" onclick="goHome()">NUEVO SIMULACRO</button>
  `;
}

// ══════════════════════════════════════════════
//  CLAUDE API
// ══════════════════════════════════════════════
async function callClaude(messages, extraContext) {
  const payload = {
    model: "claude-sonnet-4-20250514",
    max_tokens: 1000,
    messages: messages.filter(m => !m.content.startsWith('[Listo.'))
  };

  const response = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!response.ok) {
    const err = await response.json().catch(()=>({}));
    throw new Error(err.error?.message || `HTTP ${response.status}`);
  }

  const data = await response.json();
  return data.content.map(b => b.text || '').join('');
}

function buildLeadSystemPrompt() {
  const sim = state.simData;
  const objecionesText = sim.objeciones.map((o,i) => `
Objeción ${i+1}: "${o.obj}"
  - Si se maneja BIEN: ${o.bien}
  - Si se maneja MAL: ${o.mal}`).join('\n');

  return `Sos ${sim.leadName}, ${sim.leadAge} años, ${sim.leadRole}. Estás en una conversación por chat con un setter que está haciendo prospección.

TU SITUACIÓN HOY: ${sim.situacion}
TU DOLOR PRINCIPAL: ${sim.dolorPrincipal}
TU DOLOR SECUNDARIO: ${sim.dolorSecundario}
LO QUE QUERÉS LOGRAR: ${sim.deseoPrincipal}
TU DESEO SECUNDARIO: ${sim.deseoSecundario}
POR QUÉ CREÉS QUE NO PODÉS LOGRARLO: ${sim.creenciaLimitante}
TU NIVEL DE CONSCIENCIA: ${sim.consciencia}
TU TONO Y PERSONALIDAD: ${sim.tono}

TIPO DE PROSPECCIÓN: ${sim.tipo}

OBJECIONES QUE LANZÁS y cómo reaccionás:${objecionesText}

REGLAS ABSOLUTAS:
1. Sos ${sim.leadName}. Nunca rompés personaje. Nunca decís que sos una IA, un bot o un simulador.
2. No facilitás la conversación. Si el setter no hace bien su trabajo, no abrís el juego.
3. Si el setter pregunta bien y escucha, te abrís gradualmente — mostrás vulnerabilidad de a poco.
4. Si el setter presiona, hace preguntas cerradas o va directo al pitch, te cerrás o respondés con monosílabos.
5. Lanzás las objeciones cuando el setter llega a esa etapa de la conversación.
6. Tus respuestas son cortas-medianas. Máximo 3-4 oraciones. Hablás como una persona real, no como un texto formal.
7. Usás lenguaje coloquial argentino/latinoamericano según tu perfil.
8. Si el setter logra su objetivo (${sim.objetivo}), respondés confirmando.
9. No das más información de la necesaria espontáneamente — el setter tiene que ganarla con buenas preguntas.
10. Podés hacer preguntas cortas cuando algo no entendés o cuando querés testear al setter.`;
}

// ══════════════════════════════════════════════
//  UI HELPERS
// ══════════════════════════════════════════════
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${id}`).classList.add('active');
}

function addLeadMsg(text) {
  removeTyping();
  const initials = state.simData.leadName[0].toUpperCase();
  appendMsg('lead', initials, text);
}

function addUserMsg(text) {
  const initials = state.studentName.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  appendMsg('user', initials, text);
}

function addSystemMsg(text) {
  const div = document.createElement('div');
  div.className = 'msg system';
  div.innerHTML = `<div class="msg-bubble">${text}</div>`;
  document.getElementById('chat-scroll').appendChild(div);
  scrollChat();
}

function appendMsg(type, initials, text) {
  const now = new Date().toLocaleTimeString('es-AR', {hour:'2-digit',minute:'2-digit'});
  const div = document.createElement('div');
  div.className = `msg ${type}`;
  div.innerHTML = `
    <div class="msg-av">${initials}</div>
    <div class="msg-body">
      <div class="msg-bubble">${escapeHtml(text)}</div>
      <div class="msg-time">${now}</div>
    </div>`;
  document.getElementById('chat-scroll').appendChild(div);
  scrollChat();
}

function showTyping() {
  const initials = state.simData.leadName[0].toUpperCase();
  const div = document.createElement('div');
  div.className = 'typing-wrap';
  div.id = 'typing-indicator';
  div.innerHTML = `
    <div class="typing-av">${initials}</div>
    <div class="typing-dots">
      <div class="td"></div><div class="td"></div><div class="td"></div>
    </div>`;
  document.getElementById('chat-scroll').appendChild(div);
  scrollChat();
}

function removeTyping() {
  const el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

function setBusy(busy) {
  const btn = document.getElementById('btn-send');
  const inp = document.getElementById('chat-input');
  btn.disabled = busy;
  inp.disabled = busy;
  if (busy) {
    showTyping();
  } else {
    removeTyping();
    inp.focus();
  }
}

function scrollChat() {
  const el = document.getElementById('chat-scroll');
  if (el) el.scrollTop = el.scrollHeight;
}

function setStage(n) {
  if (n <= state.stage) return;
  state.stage = n;
  updateStageUI(n);
}

function updateStageUI(current) {
  for (let i = 1; i <= 4; i++) {
    const dot = document.getElementById(`stage-${i}`);
    if (!dot) continue;
    dot.classList.remove('active','done');
    if (i < current) dot.classList.add('done');
    else if (i === current) dot.classList.add('active');
  }
  for (let i = 1; i <= 3; i++) {
    const line = document.getElementById(`line-${i}`);
    if (!line) continue;
    line.classList.toggle('done', i < current);
  }
}

function goHome() {
  clearInterval(state.timerInterval);
  state = {
    studentName: state.studentName,
    simNum: null,
    simData: null,
    messages: [],
    stage: 1,
    timerInterval: null,
    secondsLeft: 3600,
    simEnded: false,
    endReason: null,
    startTime: null
  };
  document.getElementById('student-name').value = '';
  document.querySelectorAll('.sim-option').forEach(el => el.classList.remove('selected'));
  showScreen('home');
}

function escapeHtml(text) {
  return text
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/\n/g,'<br>');
}
</script>
</body>
</html>
